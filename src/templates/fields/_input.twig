{% import "_includes/forms" as forms %}

{% set editorHeight = field.getEditorHeight() %}
{% set effectiveLanguage = field.getEffectiveLanguage() %}
{% set languageClass = 'language-' ~ effectiveLanguage %}
{% set settings = craft.app.plugins.getPlugin('code-highlighter').settings %}
{% set theme = settings.defaultTheme %}
{% set tabWidth = field.tabWidth %}
{% set fontSize = field.getEffectiveFontSize() %}
{% set availableLanguages = field.getAvailableLanguagesForField() %}

<div class="code-highlighter-field prism-{{ theme }}">
    {% if field.showLanguageDropdown and availableLanguages|length > 1 %}
        <div class="code-language-selector" style="margin-bottom: 0.5rem;">
            <label for="{{ id }}-lang-switch">{{ 'Language'|t('code-highlighter') }}</label>
            <select id="{{ id }}-lang-switch" class="code-lang-switcher" data-field-id="{{ namespacedId }}">
                {% for langKey, langLabel in availableLanguages %}
                    <option value="{{ langKey }}" {% if langKey == effectiveLanguage %}selected{% endif %}>
                        {{ langLabel }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    <pre spellcheck="false" style="min-height: {{ editorHeight }}px; font-size: {{ fontSize }}px; {{ field.wordWrap ? 'white-space: pre-wrap; word-wrap: break-word;' : '' }}" class="code-editor prism-syntax-highlighter {{ field.lineNumbers ? 'line-numbers' : '' }}"><code style="tab-size: {{ tabWidth }}; -moz-tab-size: {{ tabWidth }}; min-height: {{ editorHeight }}px; font-size: {{ fontSize }}px;" class="{{ languageClass }} {{ field.lineNumbers ? 'line-numbers' : '' }}" contenteditable>{% if value | length %}{{ value }}{% endif %}</code></pre>

    <div class="hidden">
        {{ forms.textareaField({
            class: 'code-textarea',
            id: namespacedId ~ '-code',
            name: name ~ '[code]',
            value: value,
        }) }}

        {% if field.showLanguageDropdown %}
            {{ forms.textField({
                id: namespacedId ~ '-language',
                name: name ~ '[language]',
                value: effectiveLanguage,
                class: 'code-language-input',
            }) }}
        {% endif %}
    </div>
</div>

{% js %}
// Initialize Code Highlighter field
$('#{{ namespacedId }}-field').codeHighlighterField();

{% if field.showLanguageDropdown %}
// Handle language switcher
(function() {
    console.log('IDs:', {
        id: '{{ id }}',
        namespacedId: '{{ namespacedId }}',
        lookingFor: '{{ id }}-lang-switch'
    });

    var $selector = $('.code-lang-switcher');
    var $field = $('#{{ namespacedId }}-field');
    var $code = $field.find('code');
    var $pre = $field.find('pre');

    console.log('Language switcher found:', {
        selector: $selector.length,
        code: $code.length,
        actualSelectorId: $selector.attr('id')
    });

    if ($selector.length && $code.length) {
        // Track loaded languages (base languages + field default)
        var loadedLanguages = ['clike', 'markup', 'javascript', 'json', '{{ effectiveLanguage }}'];
        var assetBaseUrl = '{{ view.assetManager.getPublishedUrl('@lindemannrock/codehighlighter/resources', true) }}';

        $selector.on('change', function() {
            var newLang = $(this).val();
            var element = $code[0];

            console.log('Switching to language:', newLang);

            // Function to apply language change after component is loaded
            function applyLanguageChange() {
                var currentCode = bililiteRange(element).text();

                // Update classes
                $code.attr('class', 'language-' + newLang + ' line-numbers');
                $pre.attr('class', 'code-editor prism-syntax-highlighter line-numbers language-' + newLang);

                // Update hidden language input (for saving)
                var $langInput = $('#{{ namespacedId }}-language');
                if ($langInput.length) {
                    $langInput.val(newLang);
                    $langInput.trigger('change'); // Trigger autosave
                }

                console.log('Classes updated, language saved:', newLang, 're-highlighting...');

                // Re-highlight
                if (typeof Prism !== 'undefined') {
                    Prism.highlightElement(element);
                    console.log('Prism.highlightElement called for:', newLang);
                }
            }

            // Check if language component is loaded
            if (loadedLanguages.indexOf(newLang) === -1) {
                console.log('Loading language component:', newLang);
                var script = document.createElement('script');
                script.src = assetBaseUrl + '/js/components/prism-' + newLang + '.min.js';
                script.onload = function() {
                    console.log('Component loaded:', newLang);
                    loadedLanguages.push(newLang);
                    applyLanguageChange();
                };
                script.onerror = function() {
                    console.error('Failed to load component:', newLang);
                };
                document.head.appendChild(script);
            } else {
                applyLanguageChange();
            }
        });
    } else {
        console.warn('Language selector or code element not found');
    }
})();
{% endif %}
{% endjs %}
