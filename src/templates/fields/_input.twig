{% set editorHeight = field.getEditorHeight() %}
{% set languageClass = 'language-' ~ activeLanguage %}
{% set settings = craft.app.plugins.getPlugin('code-highlighter').settings %}
{% set theme = settings.defaultTheme %}
{% set tabWidth = field.tabWidth %}
{% set fontSize = field.getEffectiveFontSize() %}
{% set availableLanguages = field.getAvailableLanguagesForField() %}

<div class="code-highlighter-field prism-{{ theme }}">
    {% if field.showLanguageDropdown and availableLanguages|length > 1 %}
        <div class="code-language-selector" style="margin-bottom: 0.5rem;">
            <label for="{{ id }}-lang-switch">{{ 'Language'|t('code-highlighter') }}</label>
            <select id="{{ id }}-lang-switch" class="code-lang-switcher" data-field-id="{{ namespacedId }}">
                {% for langKey, langLabel in availableLanguages %}
                    <option value="{{ langKey }}" {% if langKey == activeLanguage %}selected{% endif %}>
                        {{ langLabel }}
                    </option>
                {% endfor %}
            </select>
        </div>
    {% endif %}

    {% set effectiveLineNumbers = field.getEffectiveLineNumbers() %}
    <pre spellcheck="false" style="min-height: {{ editorHeight }}px; font-size: {{ fontSize }}px; {{ field.wordWrap ? 'white-space: pre-wrap; word-wrap: break-word;' : '' }}" class="code-editor prism-syntax-highlighter {{ effectiveLineNumbers ? 'line-numbers' : '' }}"><code style="tab-size: {{ tabWidth }}; -moz-tab-size: {{ tabWidth }}; min-height: {{ editorHeight }}px; font-size: {{ fontSize }}px;" class="{{ languageClass }} {{ effectiveLineNumbers ? 'line-numbers' : '' }}" contenteditable>{% if value | length %}{{ value }}{% endif %}</code></pre>

    <textarea name="{{ name }}[code]" class="code-textarea" style="display:none">{{ value }}</textarea>
    <input type="hidden" name="{{ name }}[language]" value="{{ activeLanguage }}" class="code-lang-value">
</div>

{% js %}
// Initialize Code Highlighter field
initCodeHighlighterField(document.getElementById('{{ namespacedId }}-field'));

{% if field.showLanguageDropdown %}
// Handle language switcher
(function() {
    var fieldEl = document.getElementById('{{ namespacedId }}-field');
    var selector = fieldEl.querySelector('.code-lang-switcher');
    var codeEl = fieldEl.querySelector('code');
    var preEl = fieldEl.querySelector('pre');

    if (selector && codeEl) {
        // Track loaded languages (base languages + field default)
        var loadedLanguages = ['clike', 'markup', 'javascript', 'json', '{{ activeLanguage }}'];
        var assetBaseUrl = '{{ view.assetManager.getPublishedUrl('@lindemannrock/codehighlighter/web/assets/prism', true) }}';

        selector.addEventListener('change', function() {
            var newLang = this.value;

            // Function to apply language change after component is loaded
            function applyLanguageChange() {
                // Update classes
                var lineNumbersClass = {{ effectiveLineNumbers ? "'line-numbers'" : "''" }};
                codeEl.className = 'language-' + newLang + (lineNumbersClass ? ' ' + lineNumbersClass : '');
                preEl.className = 'code-editor prism-syntax-highlighter ' + (lineNumbersClass ? lineNumbersClass + ' ' : '') + 'language-' + newLang;

                // Update hidden language input (for saving)
                var langInput = fieldEl.querySelector('.code-lang-value');
                if (langInput) {
                    langInput.value = newLang;
                    langInput.dispatchEvent(new Event('change', { bubbles: true }));
                }

                // Re-highlight
                if (typeof Prism !== 'undefined') {
                    Prism.highlightElement(codeEl);
                }
            }

            // Check if language component is loaded
            if (loadedLanguages.indexOf(newLang) === -1) {
                var script = document.createElement('script');
                script.src = assetBaseUrl + '/js/components/prism-' + newLang + '.min.js';
                script.onload = function() {
                    loadedLanguages.push(newLang);
                    applyLanguageChange();
                };
                document.head.appendChild(script);
            } else {
                applyLanguageChange();
            }
        });
    }
})();
{% endif %}
{% endjs %}
